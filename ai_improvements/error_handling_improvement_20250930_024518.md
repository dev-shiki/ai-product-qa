# Error Handling Improvement

**File**: `./app/api/queries.py`  
**Time**: 02:45:18  
**Type**: error_handling_improvement

## Improvement

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        try:
            ai_response = await ai_service.get_response(request.question)
        except Exception as e:
            logger.error(f"Error getting AI response: {e}")
            raise HTTPException(status_code=500, detail="Failed to get response from AI service.") from e
        
        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None
        
        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }
        
... (truncated for analysis)
```

Key improvements in this section:

* **Targeted Error Handling:** The primary change is wrapping the `ai_service.get_response()` call in its own `try...except` block.  This isolates the error handling specifically to the AI service call, making debugging easier.

* **Detailed Logging:**  The `logger.error()` statement now includes the exception `e` itself. This provides significantly more information about the failure (the type of exception, the error message) in the logs.  This is crucial for diagnosing issues.

* **HTTPException with `from`:** When an exception occurs in the AI service call, an `HTTPException` is raised.  Critically, the `from e` clause is added to the `raise` statement.  This preserves the *original* exception's traceback, making debugging much simpler.  Without `from e`, the traceback would start only at the `HTTPException`, obscuring the root cause.  The `detail` provides a user-friendly error message.

* **Status Code:**  Uses a `500` status code (`Internal Server Error`) for failures within the AI service.  This is more appropriate than a generic `400` (Bad Request) because the error is on the server side (the AI service failed), not a problem with the client's request.

* **Clear Error Message:** The `detail` argument in the `HTTPException` provides a user-friendly error message that can be returned to the client.

Why these changes are important:

1. **Robustness:** Prevents the entire endpoint from crashing if the AI service is temporarily unavailable or encounters an error.
2. **Debuggability:**  The logging and traceback preservation make it much easier to identify and fix the underlying issues causing the errors.
3. **User Experience:** Provides a more informative error message to the client, rather than a generic failure.
4. **Correct Status Code:** Returning the appropriate HTTP status code allows clients to handle errors correctly.

This improved error handling makes the endpoint significantly more resilient and maintainable. Remember to apply similar error handling patterns to other potential points of failure within your code.

---
*Generated by Smart AI Bot*
