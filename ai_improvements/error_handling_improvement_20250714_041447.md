# Error Handling Improvement

**File**: `./app/api/queries.py`  
**Time**: 04:14:47  
**Type**: error_handling_improvement

## Improvement

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException, status
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        try:
            ai_response = await ai_service.get_response(request.question)
        except Exception as e:
            logger.error(f"Error getting AI response: {e}")
            raise HTTPException(status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Failed to get AI response.") from e # Preserve original exception

        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None
        
        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }
        
... (truncated for analysis)
```

Key improvements and explanations:

* **Dedicated `try...except` for AI Service Call:** The most important change is wrapping the `ai_service.get_response()` call in its own `try...except` block.  This isolates errors that *only* occur during the AI service call. This prevents other potential errors in the `ask_question` function from being incorrectly attributed to the AI service.
* **Logging the Exception:**  Inside the `except` block, `logger.error(f"Error getting AI response: {e}")` logs the error message.  This is crucial for debugging and understanding why the AI service failed.  Include the exception `e` in the log message to see the full traceback and error details.
* **Raising an `HTTPException`:** Instead of silently failing or returning potentially incorrect data, the `except` block now raises an `HTTPException`.  This immediately tells the client (the user or calling application) that something went wrong with the AI service.
    * **Status Code:**  The `status_code=status.HTTP_503_SERVICE_UNAVAILABLE` is used.  This is the correct HTTP status code to indicate that a service the API depends on is unavailable. Using an appropriate status code is essential for proper API behavior.
    * **Detail Message:** `detail="Failed to get AI response."` provides a user-friendly error message.  This helps the client understand the nature of the problem.  Avoid exposing sensitive internal details in the error message.
    * **`from e`:** The `raise HTTPException(...) from e` syntax is very important. It preserves the original exception's traceback and context. This makes debugging *much* easier, as you can trace back to the root cause of the error within the AI service.  Without `from e`, the traceback would only show the `HTTPException` being raised here, hiding the original error in the `ai_service`.

This revised code provides a much more robust and informative error handling strategy for the AI service call. It logs errors, communicates failures to the client with appropriate status codes, and preserves the original exception context for debugging. This addresses the prompt's request to improve error handling in *one* part of the code (the AI service call) while adhering to best practices.

---
*Generated by Smart AI Bot*
