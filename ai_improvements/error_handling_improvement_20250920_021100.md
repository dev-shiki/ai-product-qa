# Error Handling Improvement

**File**: `./app/api/queries.py`  
**Time**: 02:11:00  
**Type**: error_handling_improvement

## Improvement

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        try:
            ai_response = await ai_service.get_response(request.question)
        except Exception as e:
            logger.error(f"Error getting AI response: {e}")
            raise HTTPException(status_code=500, detail="Failed to get response from AI service.") from e  # Include original exception

        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None
        
        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }

... (truncated for analysis)
```

Key improvements and explanations:

* **Nested `try...except` Block for AI Service:** The critical part of the code that was failing (the call to the AI service) is now wrapped in its own `try...except` block *within* the outer `try` block. This allows for specific error handling for failures to communicate with the AI service.
* **Detailed Logging:**  The `except` block now logs the error message using `logger.error`.  Crucially, it includes the exception `e` itself in the log message using an f-string: `f"Error getting AI response: {e}"`.  This will print the full traceback in the logs, which is vital for debugging.
* **HTTPException with Status Code 500:** Instead of silently failing, the code now raises an `HTTPException` with a status code of 500 (Internal Server Error) when the AI service call fails. This signals to the client that something went wrong on the server side.  A meaningful `detail` message is provided for the client to understand the error.
* **`from e` in `raise HTTPException`:** The `from e` clause when raising the `HTTPException` is *critical*. It preserves the original exception's traceback information.  Without it, you would lose the stack trace that pinpointed the actual source of the error in the `ai_service`. The FastAPI framework will use this information to help generate better error responses and logs.
* **Avoid Catching Broad Exceptions:**  The `except Exception as e:` is acceptable *in this specific context* because it's handling a service call that could potentially fail for numerous reasons (network issues, API errors, etc.).  However, in general, you should try to catch more specific exception types when possible.  In this case, you might have more specific `except` clauses for `requests.exceptions.RequestException`, `TimeoutError`, or other potential exceptions the `ai_service` might raise.  That would provide even more targeted error handling.
* **Clarity and Consistency:** The logging and error handling are now much clearer and more consistent. This makes the code more robust and easier to maintain.

This improved version provides much better insight into errors, handles them gracefully by returning an appropriate HTTP error, and includes complete debugging information. This is essential for production applications.

---
*Generated by Smart AI Bot*
