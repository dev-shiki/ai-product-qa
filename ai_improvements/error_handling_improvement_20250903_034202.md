# Error Handling Improvement

**File**: `./tests/test_ai_service.py`  
**Time**: 03:42:02  
**Type**: error_handling_improvement

## Improvement

```python
import pytest
from unittest.mock import patch, AsyncMock, MagicMock
from app.services.ai_service import AIService

@pytest.mark.asyncio
async def test_get_response():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_response = MagicMock()
        mock_response.text = "Test response"
        mock_generate.return_value = mock_response
        
        response = await service.get_response("Test question")
        assert response == "Test response"

@pytest.mark.asyncio
async def test_get_response_with_error():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_generate.side_effect = Exception("API Error")
        
        with pytest.raises(Exception, match="API Error"):
            await service.get_response("Test question")

@pytest.mark.asyncio
async def test_get_response_with_empty_question():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_response = MagicMock()
        mock_response.text = "Pertanyaan tidak boleh kosong"
        mock_generate.return_value = mock_response
        
        response = await service.get_response("")
        assert "Pertanyaan tidak boleh kosong" in response

@pytest.mark.asyncio
async def test_get_response_with_long_question():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_response = MagicMock()
        mock_response.text = "Pertanyaan terlalu panjang"
        mock_generate.return_value = mock_response
        
        long_question = "A" * 1000
        response = await service.get_response(long_question)
        assert "Pertanyaan terlalu panjang" in response

@pytest.mark.asyncio
async def test_get_response_with_special_characters():
    service = AIService()
...(truncated for analysis)
```

**Reasoning for the change:**

The original `test_get_response_with_error` test was flawed in its error handling verification. It was expecting the `get_response` method to return a specific string ("Maaf, saya sedang mengalami kesulitan") when an exception occurred.  This approach has several drawbacks:

1. **Brittle Test:** The test is tightly coupled to the exact error message returned by the `get_response` method.  If the message changes in the future (perhaps due to a localization update or a code refactoring), the test will break even if the error handling logic is still correct.

2. **Lack of Specificity:** The test only checks for the presence of a substring within the response.  This is not a robust way to verify that the correct type of exception was raised and handled.

3. **Not testing the exception:** The original code does not test if the exception is actually raised. It just checks if the returned response contains a certain string, which is not a good way to handle exceptions.

The improved code addresses these issues by:

1. **Using `pytest.raises`:** This context manager asserts that a specific exception (or a subclass of it) is raised within the `await service.get_response("Test question")` block.

2. **Verifying the Exception Type and Message:** `pytest.raises(Exception, match="API Error")` asserts that an `Exception` is raised and that the exception message contains the string "API Error". This is a much more specific and reliable way to verify error handling. If a different exception is raised, the test will fail.  If the exception message doesn't contain "API Error", the test will also fail.

This approach provides a more robust and maintainable test that specifically validates the exception handling logic within the `get_response` method.  It ensures that the expected exception is raised and that the exception message is as expected, avoiding false positives and making the test more resilient to changes in the underlying code.

---
*Generated by Smart AI Bot*
