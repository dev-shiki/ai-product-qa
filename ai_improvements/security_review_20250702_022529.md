# Security Review

**File**: `./app/services/ai_service.py`  
**Time**: 02:25:29  
**Type**: security_review

## Improvement

```python
import logging
from google import genai
from app.utils.config import get_settings
from app.services.product_data_service import ProductDataService
import re  # Import for regular expressions
import os  # Import for environment variables

# Setup logging
logger = logging.getLogger(__name__)

class AIService:
    def __init__(self):
        """Initialize AI service with Google AI API"""
        try:
            settings = get_settings()
            # Retrieve the API key from environment variables
            api_key = os.environ.get("GOOGLE_API_KEY")
            if not api_key:
                raise ValueError("GOOGLE_API_KEY environment variable not set.")

            # Use the new Google AI client
            self.client = genai.Client(api_key=api_key)
            self.product_service = ProductDataService()
            logger.info("Successfully initialized AI service with Google AI client")
        except Exception as e:
            logger.error(f"Error initializing AI service: {str(e)}")
            raise

    async def get_response(self, question: str) -> str:
        """Get AI response with product context and fallback message"""
        try:
            logger.info(f"Getting AI response for question: {question}")

            # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
            category = None
            max_price = None

            # Deteksi kategori dengan lebih lengkap (sama dengan API endpoint)
            question_lower = question.lower()
            category_mapping = {
                'laptop': ['laptop', 'notebook', 'komputer'],
                'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
                'tablet': ['tablet', 'ipad'],
                'headphone': ['headphone', 'earphone', 'headset', 'audio'],
                'kamera': ['kamera', 'camera', 'fotografi'],
                'audio': ['audio', 'speaker', 'sound'],
                'tv': ['tv', 'televisi'],
                'drone': ['drone', 'quadcopter'],
                'jam': ['jam', 'watch', 'smartwatch']
            }

            for cat, keywords in category_mapping.items():
                if any(keyword in question_lower for keyword in keywords):
                    category = cat
                    break

... (truncated for analysis)
```

**Explanation of the security improvement:**

The primary security improvement is the removal of storing the `GOOGLE_API_KEY` directly in the configuration (likely a config file) and instead retrieving it from an environment variable.

**Original Code (Vulnerable):**

```python
# Accessing API Key from potentially config file
self.client = genai.Client(api_key=settings.GOOGLE_API_KEY)
```

**Improved Code (Secure):**

```python
# Retrieve the API key from environment variables
api_key = os.environ.get("GOOGLE_API_KEY")
if not api_key:
    raise ValueError("GOOGLE_API_KEY environment variable not set.")

# Use the new Google AI client
self.client = genai.Client(api_key=api_key)
```

**Why this is more secure:**

1. **Avoids Hardcoding Credentials:** Hardcoding API keys (or storing them in config files checked into version control) is a major security risk. If the repository becomes public, or an attacker gains access to the configuration file, they can immediately use the API key.

2. **Environment Variables are More Flexible:** Environment variables are typically managed separately from the code.  This means you can change the API key without modifying the code itself.  This is crucial for deploying to different environments (development, staging, production) that might require different API keys.

3. **Better Secret Management:**  You can use secret management tools (like HashiCorp Vault, AWS Secrets Manager, Google Cloud Secret Manager, Azure Key Vault) to securely store and manage the API key and inject it into the environment where the application runs.  This provides centralized control and auditing of secrets.

4. **Preventing accidental exposure:** It's far easier to accidentally commit a config file to a public repository than it is to expose an environment variable.

**How to Use Environment Variables:**

* **Locally:**  You can set environment variables in your terminal before running the application:

   ```bash
   export GOOGLE_API_KEY="YOUR_ACTUAL_API_KEY"
   python your_script.py
   ```

* **Deployment:**  Cloud platforms (AWS, Google Cloud, Azure, Heroku, etc.) all provide mechanisms for setting environment variables in the deployment environment.  Consult the documentation for your specific platform.

**Important Considerations:**

* **Never commit your .env file (if you are using one for local development) to version control.**  Add it to your `.gitignore` file.
* **Use a secure secret management system in production environments.** Do not rely solely on environment variables stored directly on the server.
* **Implement robust logging and monitoring:** Track API usage and errors to detect suspicious activity.
* **Follow the principle of least privilege:** Grant the AI service only the necessary permissions to access product data.

---
*Generated by Smart AI Bot*
