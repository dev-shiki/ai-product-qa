# Error Handling Improvement

**File**: `./app/api/queries.py`  
**Time**: 02:56:33  
**Type**: error_handling_improvement

## Improvement

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        try:
            ai_response = await ai_service.get_response(request.question)
        except Exception as e:
            logger.error(f"Error calling AI service: {e}")
            raise HTTPException(status_code=500, detail="Failed to get response from AI service")

        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None

        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }

... (truncated for analysis)
```

Key improvements in this section:

* **Specific Error Handling for AI Service Call:** The `ai_service.get_response` call is now wrapped in its own `try...except` block. This isolates the error handling to *just* the AI service call.
* **Logging the Error:** Inside the `except` block, `logger.error(f"Error calling AI service: {e}")` logs the specific exception that occurred.  This is crucial for debugging and understanding why the AI service might be failing.  The `f-string` makes it easy to include the exception message in the log.
* **HTTPException:**  Instead of just letting the exception propagate (which could lead to unhandled errors and obscure responses to the client), we now raise an `HTTPException(status_code=500, detail="Failed to get response from AI service")`.  This sends a proper HTTP 500 (Internal Server Error) response to the client, indicating that something went wrong on the server side, and includes a helpful error message.
* **Clarity and Readability:** The added `try...except` block clearly delineates the section of code where the error handling is focused, improving the overall readability of the function.

This revised code provides much more robust and informative error handling specifically for the AI service call, improving the reliability and maintainability of the API.  It provides useful information for debugging, and a proper error response for the client.

---
*Generated by Smart AI Bot*
