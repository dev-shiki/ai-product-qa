# Code Optimization

**File**: `./tests/test_queries.py`  
**Time**: 10:57:39  
**Type**: code_optimization

## Improvement

```python
import pytest
from httpx import AsyncClient, ASGITransport
from unittest.mock import patch, AsyncMock

from app.main import app  # Import app here

@pytest.fixture(scope="module")
async def async_client():
    async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
        yield ac

@pytest.mark.asyncio
@patch("app.api.queries.product_service")
@patch("app.api.queries.ai_service")
async def test_ask_question(mock_ai, mock_product, async_client):
    mock_ai.get_response = AsyncMock(return_value="Jawaban AI")
    mock_product.smart_search_products = AsyncMock(return_value=(
        [{"id": "P001", "name": "iPhone 15 Pro Max"}], 
        "Berikut produk yang sesuai dengan kriteria Anda."
    ))
    resp = await async_client.post("/api/queries/ask", json={"question": "Apa laptop terbaik?"})
    assert resp.status_code == 200
    data = resp.json()
    assert data["answer"] == "Jawaban AI"
    assert isinstance(data["products"], list)
    assert len(data["products"]) > 0
    assert "note" in data
    assert data["note"] == "Berikut produk yang sesuai dengan kriteria Anda."

@pytest.mark.asyncio
async def test_get_suggestions(async_client):
    resp = await async_client.get("/api/queries/suggestions")
    assert resp.status_code == 200
    data = resp.json()
    assert "suggestions" in data
    assert isinstance(data["suggestions"], list)

@pytest.mark.asyncio
@patch("app.api.queries.product_service")
async def test_get_categories(mock_service, async_client):
    mock_service.get_categories = AsyncMock(return_value=["smartphone", "laptop", "tablet"])
    resp = await async_client.get("/api/queries/categories")
    assert resp.status_code == 200
    data = resp.json()
    assert "categories" in data
    assert set(data["categories"]) >= {"smartphone", "laptop", "tablet"}

@pytest.mark.asyncio
@patch("app.api.queries.product_service")
async def test_get_brands(mock_service, async_client):
    mock_service.get_brands.return_value = ["Apple", "Samsung", "Sony"]
... (truncated for analysis)
```

**Improvement:**

Create a pytest fixture for the `AsyncClient`.

**Explanation:**

The original code creates a new `AsyncClient` instance within each test function.  This involves initializing the ASGI transport for each test, which can be relatively slow. By using a fixture with `scope="module"`, we create the `AsyncClient` *once* for the entire module. This `AsyncClient` instance is then injected into each test function that needs it via the function argument.  This avoids redundant setup and teardown, significantly speeding up test execution, especially for tests that make multiple requests. Also, I've hoisted the `from app.main import app` import statement outside the test function, since it's used by all of them and only needs to be imported once.  This cleans up each test and provides a minor performance benefit as well.

---
*Generated by Smart AI Bot*
