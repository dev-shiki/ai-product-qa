# Error Handling Improvement

**File**: `./app/api/queries.py`  
**Time**: 02:01:13  
**Type**: error_handling_improvement

## Improvement

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        try:
            ai_response = await ai_service.get_response(request.question)
        except Exception as e:
            logger.exception("Error getting AI response:")
            raise HTTPException(status_code=500, detail=f"Failed to get AI response: {str(e)}")

        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None

        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }
... (truncated for analysis)

```

Key improvements:

* **Specific `try...except` block around `ai_service.get_response()`:**  The original code had a single `try...except` encompassing a larger block.  This isolates the potential error from the AI service call, allowing for more targeted handling.  It's now clear *where* the error originated.
* **Detailed Exception Logging:** `logger.exception("Error getting AI response:")` logs the full traceback of the exception, making debugging significantly easier.  Crucially, `logger.exception` should be used to log the entire stack trace for error analysis.
* **HTTPException with informative message:**  Instead of a generic error, `raise HTTPException(status_code=500, detail=f"Failed to get AI response: {str(e)}")` returns a proper HTTP 500 error with a user-friendly message including the original exception.  This gives the client information about what went wrong.  The `str(e)` part includes the error message from the underlying exception, providing essential context.
* **Status Code Selection:** Using `status_code=500` is appropriate for server-side errors.  If the problem were due to bad input from the user (e.g., a malformed query), a `400 Bad Request` error might be more suitable.
* **Removed Unnecessary `finally`:**  There's no `finally` block because no cleanup is needed regardless of whether an exception occurs.

This revised code provides robust error handling specifically around the AI service call, logging errors effectively and returning informative HTTP error responses to the client.  This significantly improves the reliability and debuggability of the API.

---
*Generated by Smart AI Bot*
