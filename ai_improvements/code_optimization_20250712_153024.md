# Code Optimization

**File**: `./app/api/queries.py`  
**Time**: 15:30:24  
**Type**: code_optimization

## Improvement

**Optimization:** Pre-compile the regular expressions used for category and price extraction.

**Explanation:**

The original code extracts category and price information from the user's question using regular expressions (within the `ask_question` function, truncated for brevity).  Regular expression compilation is relatively expensive.  By compiling the regexes *once* at the module level (outside the `ask_question` function) and storing them in variables, you avoid recompiling them on every request.  This small change can significantly improve the performance of the `/ask` endpoint, especially under high load.

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

# Pre-compile regular expressions
price_pattern = re.compile(r"maksimal\s?Rp\s?([\d,]+)", re.IGNORECASE)  #Example of one regex to precompile
category_pattern_laptop = re.compile(r"(laptop|notebook|komputer)", re.IGNORECASE) #Example of another

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        ai_response = await ai_service.get_response(request.question)
        
        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None
        
        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }

... (rest of the function, using price_pattern.search(request.question) instead of re.search(...))
```

**Important:**  This example only shows two of the many regexes that were likely in the truncated code.  You should pre-compile *all* regular expressions used within the `ask_question` function that are defined directly in the function.

---
*Generated by Smart AI Bot*
