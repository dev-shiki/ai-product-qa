# Security Review

**File**: `./app/services/product_data_service.py`  
**Time**: 03:17:57  
**Type**: security_review

## Improvement

```python
import logging
from typing import List, Dict, Optional
from app.services.local_product_service import LocalProductService
import bleach  # Import bleach

logger = logging.getLogger(__name__)

class ProductDataService:
    """
    Service untuk mengambil data produk dari sumber lokal yang reliable
    """
    
    def __init__(self):
        # Use LocalProductService as primary data source
        self.local_service = LocalProductService()
        logger.info("ProductDataService initialized with LocalProductService")
    
    async def search_products(self, keyword: str, limit: int = 10) -> List[Dict]:
        """Search products using local data"""
        try:
            # Sanitize the keyword to prevent injection attacks
            sanitized_keyword = bleach.clean(keyword)
            logger.info(f"Searching products with keyword: {sanitized_keyword}")
            # Use awaitable wrapper for sync method
            import asyncio
            loop = asyncio.get_event_loop()
            products = await loop.run_in_executor(None, self.local_service.search_products, sanitized_keyword, limit)
            logger.info(f"Found {len(products)} products for keyword: {sanitized_keyword}")
            return products
        except Exception as e:
            logger.error(f"Error searching products: {str(e)}")
            return []
    
    async def get_products(self, limit: int = 20, category: Optional[str] = None, search: Optional[str] = None) -> List[Dict]:
        """Get products with optional filtering"""
        try:
            if search:
                # Sanitize the search term
                sanitized_search = bleach.clean(search)
                return await self.search_products(sanitized_search, limit)
            elif category:
                return self.get_products_by_category(category, limit)
            else:
                return self.get_all_products(limit)
        except Exception as e:
            logger.error(f"Error getting products: {str(e)}")
            return self.local_service.get_products(limit)
    
    async def get_categories(self) -> List[str]:
        """Get available categories"""
        try:
            return self.local_service.get_categories()
        except Exception as e:
            logger.error(f"Error getting categories: {str(e)}")
            return []

... (truncated for analysis)
```

**Explanation:**

The suggested security improvement is **input sanitization** using the `bleach` library.  Specifically, the `keyword` parameter in the `search_products` method and the `search` parameter in the `get_products` method are now sanitized using `bleach.clean()`.

**Why this is important:**

Without sanitization, the `keyword` and `search` parameters are vulnerable to injection attacks (e.g., SQL injection, if `LocalProductService` directly constructs SQL queries, or cross-site scripting (XSS) if the keyword is later displayed on a web page without proper encoding). An attacker could inject malicious code into these parameters, potentially compromising the application or its data.

**How it works:**

*   **`import bleach`**: This line imports the `bleach` library, which is a fast and easy-to-use allowlist-based HTML sanitization library.  It's designed to strip out malicious HTML tags and attributes.
*   **`sanitized_keyword = bleach.clean(keyword)`**:  This line uses `bleach.clean()` to sanitize the input `keyword`.  `bleach.clean()` removes any HTML tags, attributes, or styles that are not explicitly allowed. By default, it strips out a broad range of potentially harmful content, making the input safe to use in further processing and display.  The `sanitized_keyword` variable now holds the safe version of the keyword.
*   **`sanitized_search = bleach.clean(search)`**: This line does the same for the `search` parameter in `get_products`.
*   The code then uses the `sanitized_keyword` (or `sanitized_search`) in subsequent operations, such as logging and passing it to the `local_service.search_products` method.

**Why `bleach` is a good choice:**

*   **Allowlist-based:** `bleach` operates on an allowlist principle, meaning you explicitly define what tags and attributes are allowed, rather than trying to blacklist potentially dangerous ones. This is generally considered a more secure approach because it is less likely to miss new or obscure attack vectors.
*   **Easy to use:** The `bleach.clean()` function provides a simple way to sanitize HTML.
*   **Fast:** It's designed for performance.

**Important Considerations:**

*   **Configuration of `bleach`:** The default configuration of `bleach` might be too restrictive for some use cases. You can customize the allowed tags, attributes, and styles to meet your specific requirements.  Refer to the `bleach` documentation for details on how to configure it.  For instance, if you *know* that the search term should *never* contain HTML, a more aggressive strip all tags approach may be warranted.
*   **Contextual Encoding:**  Sanitization is only *one* part of defense in depth.  If the sanitized data is later displayed on a web page, *always* use proper output encoding for the specific context (e.g., HTML escaping, URL encoding, JavaScript escaping) to prevent XSS vulnerabilities.  Sanitization removes malicious HTML, but encoding ensures that any *remaining* potentially unsafe characters are treated as data, not code.
*   **Data Type Validation:**  Consider adding validation to ensure that the `limit` parameter is an integer within a reasonable range. This can prevent denial-of-service attacks (e.g., by setting the limit to a very large number).
*   **Error Handling:** While the code has `try...except` blocks, consider more specific exception handling.  Logging the general exception and returning an empty list might mask underlying problems.  Determine which exceptions are truly recoverable and handle them appropriately, and re-raise others.
*   **`LocalProductService` Security:** The security of the entire system depends on the `LocalProductService` and the data source it uses. Make sure that `LocalProductService` is also secure and does not introduce vulnerabilities. If `LocalProductService` is interacting with a database, use parameterized queries or an ORM to prevent SQL injection vulnerabilities in that layer as well.  The sanitization in `ProductDataService` provides an extra layer of defense but doesn't replace the need for secure practices in other components.

This improved code snippet provides a more secure way to handle user input and reduces the risk of injection attacks. Remember to adapt the `bleach` configuration to your specific needs and always practice defense in depth.

---
*Generated by Smart AI Bot*
