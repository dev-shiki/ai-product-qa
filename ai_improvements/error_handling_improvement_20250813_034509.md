# Error Handling Improvement

**File**: `./tests/test_ai_service.py`  
**Time**: 03:45:09  
**Type**: error_handling_improvement

## Improvement

```python
import pytest
from unittest.mock import patch, AsyncMock, MagicMock
from app.services.ai_service import AIService

@pytest.mark.asyncio
async def test_get_response():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_response = MagicMock()
        mock_response.text = "Test response"
        mock_generate.return_value = mock_response
        
        response = await service.get_response("Test question")
        assert response == "Test response"

@pytest.mark.asyncio
async def test_get_response_with_error():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_generate.side_effect = Exception("API Error")
        
        with pytest.raises(Exception, match="API Error"):  # Verify exception raised
            await service.get_response("Test question")


@pytest.mark.asyncio
async def test_get_response_with_empty_question():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_response = MagicMock()
        mock_response.text = "Pertanyaan tidak boleh kosong"
        mock_generate.return_value = mock_response
        
        response = await service.get_response("")
        assert "Pertanyaan tidak boleh kosong" in response

@pytest.mark.asyncio
async def test_get_response_with_long_question():
    service = AIService()
    with patch.object(service.client.models, 'generate_content') as mock_generate:
        mock_response = MagicMock()
        mock_response.text = "Pertanyaan terlalu panjang"
        mock_generate.return_value = mock_response
        
        long_question = "A" * 1000
        response = await service.get_response(long_question)
        assert "Pertanyaan terlalu panjang" in response

@pytest.mark.asyncio
async def test_get_response_with_special_characters():
    service = AIService()
... (truncated for analysis)
```

Key improvements and explanations:

* **`test_get_response_with_error` now uses `pytest.raises`**: This is the most important change. Instead of trying to recover from the exception and assert a specific message, we now assert that the expected exception is *actually raised*. This is the correct way to test error handling.  If `service.get_response()` *doesn't* raise an exception when `mock_generate` is set to raise one, the test will fail, which is exactly what we want.  The `match="API Error"` argument ensures the correct exception is being raised.
* **Removes potentially misleading assertions:** The original code asserted that the returned response contains "Maaf, saya sedang mengalami kesulitan". This hides the fact that an exception occurred.  The purpose of this test should be to verify that the exception is handled correctly (e.g., re-raised or caught and logged), not to check the specific error message the AI might return.  The service itself should be responsible for providing this graceful messaging.  The tests should verify that the exception *propagation* is correct.
* **Why this is better:**
    * **More accurate testing of error handling:**  It directly verifies that the expected exception occurs.
    * **Avoids masking errors:** If the `get_response` method doesn't actually raise an exception (perhaps because the error handling logic changed), the original test would still pass because it just checked for a specific message. The revised test will fail, alerting us to the problem.
    * **More robust:** This approach is more resilient to changes in the error message that the `AIService` might return. We care about the exception being raised, not the exact error message string.
    * **Clearer intent:** The `pytest.raises` context manager clearly states the intention of the test: to ensure that a specific exception is raised under certain circumstances.

This revised `test_get_response_with_error` test is significantly better because it directly verifies the correct error handling behavior (exception raising) rather than relying on assertions about the content of the returned string, which can be misleading and brittle.

---
*Generated by Smart AI Bot*
