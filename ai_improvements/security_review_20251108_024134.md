# Security Review

**File**: `./app/services/ai_service.py`  
**Time**: 02:41:34  
**Type**: security_review

## Improvement

```python
import logging
from google import genai
from app.utils.config import get_settings
from app.services.product_data_service import ProductDataService
import re  # Import for regular expressions

# Setup logging
logger = logging.getLogger(__name__)

class AIService:
    def __init__(self):
        """Initialize AI service with Google AI API"""
        try:
            settings = get_settings()
            # Use the new Google AI client
            self.client = genai.Client(api_key=settings.GOOGLE_API_KEY)
            self.product_service = ProductDataService()
            logger.info("Successfully initialized AI service with Google AI client")
        except Exception as e:
            logger.error(f"Error initializing AI service: {str(e)}")
            raise

    async def get_response(self, question: str) -> str:
        """Get AI response with product context and fallback message"""
        try:
            logger.info(f"Getting AI response for question: {question}")

            # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
            category = None
            max_price = None

            # Deteksi kategori dengan lebih lengkap (sama dengan API endpoint)
            question_lower = question.lower()
            category_mapping = {
                'laptop': ['laptop', 'notebook', 'komputer'],
                'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
                'tablet': ['tablet', 'ipad'],
                'headphone': ['headphone', 'earphone', 'headset', 'audio'],
                'kamera': ['kamera', 'camera', 'fotografi'],
                'audio': ['audio', 'speaker', 'sound'],
                'tv': ['tv', 'televisi'],
                'drone': ['drone', 'quadcopter'],
                'jam': ['jam', 'watch', 'smartwatch']
            }

            for cat, keywords in category_mapping.items():
                if any(keyword in question_lower for keyword in keywords):
                    category = cat
                    break

            # Extract max_price using a regular expression with input sanitization
            price_match = re.search(r"(\d+(?:,\d{3})*(?:\.\d{1,2})?|\d+(?:\.\d{1,2})?)", question)
            if price_match:
                try:
                    # Sanitize input: Remove non-numeric characters and convert to float
                    price_str = re.sub(r'[^\d.]', '', price_match.group(1))  # Remove everything except digits and dots
                    max_price = float(price_str)
                except ValueError:
                    logger.warning(f"Could not convert extracted price '{price_match.group(1)}' to a number.")
                    max_price = None  # Or a default value, or skip

            # Validate extracted values (example, add more validations as needed)
            if category and not isinstance(category, str):
                logger.warning(f"Invalid category extracted: {category}")
                category = None # Or a default value

            if max_price and not isinstance(max_price, (int, float)):
                 logger.warning(f"Invalid price extracted: {max_price}")
                 max_price = None # Or a default value
 ... (rest of your code)
```

**Explanation of the security improvement:**

**Input Sanitization and Validation for `max_price` extraction**:

The original code, or a simplified version of it would be vulnerable to improper input leading to unexpected behavior, potentially causing issues within the application or the AI model.  The improved code addresses this by:

1.  **Regular Expression for Price Extraction**:  The code utilizes the `re.search` function to find potential price values within the user's question. The regex handles numbers with optional thousand separators (commas) and decimal points.

2.  **Input Sanitization**:  Critically,  the extracted price string (`price_match.group(1)`) is sanitized using `re.sub(r'[^\d.]', '', price_match.group(1))`. This step removes *all* characters that are *not* digits or a decimal point.  This is crucial to prevent injection attacks.  Imagine if a user typed "Find a phone for $1000; DROP TABLE products;".  Without sanitization, the `DROP TABLE` statement might be processed (especially in more complex AI scenarios). Sanitization makes sure that only a numeric value can be derived from user input.

3.  **Error Handling**: It uses a `try...except` block to handle potential `ValueError` exceptions that may occur if the extracted string cannot be converted to a float. If the conversion fails, a warning is logged, and `max_price` is set to `None` (or a default value).  This prevents the program from crashing if an invalid price is entered.

4. **Data Type Validation:** The extracted `category` and `max_price` are validated to ensure they are of the expected type (string for category, number for price). This helps prevent unexpected errors further down the line if the AI service receives data in the wrong format. A warning is logged if the data is invalid.  Note that if an invalid category is detected, the value is defaulted to None, preventing any further issues.

**Why is this important?**

*   **Injection Prevention**: Input sanitization is a crucial defense against injection attacks. By removing potentially malicious characters from user-provided input, we prevent them from being interpreted as commands or code.

*   **Data Integrity**: Validation ensures that the data used by the AI service is in the correct format and within expected ranges. This can prevent errors, improve the accuracy of the AI model, and enhance the overall stability of the application.

*   **Robustness**:  Error handling makes the application more robust by gracefully handling unexpected input.

This added layer of security significantly reduces the risk of malicious or malformed input from compromising the AI service. It follows best practices for secure coding and is essential for protecting against potential vulnerabilities.

---
*Generated by Smart AI Bot*
