# Code Optimization

**File**: `./tests/test_queries.py`  
**Time**: 10:57:31  
**Type**: code_optimization

## Improvement

```python
import pytest
from httpx import AsyncClient, ASGITransport
from unittest.mock import patch, AsyncMock

from app.main import app  # Import app once at the top

@pytest.fixture(scope="module")  # Create a fixture for the async client
async def async_client():
    async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
        yield ac


@pytest.mark.asyncio
@patch("app.api.queries.product_service")
@patch("app.api.queries.ai_service")
async def test_ask_question(mock_ai, mock_product, async_client): # Inject the fixture
    mock_ai.get_response = AsyncMock(return_value="Jawaban AI")
    mock_product.smart_search_products = AsyncMock(return_value=(
        [{"id": "P001", "name": "iPhone 15 Pro Max"}], 
        "Berikut produk yang sesuai dengan kriteria Anda."
    ))

    resp = await async_client.post("/api/queries/ask", json={"question": "Apa laptop terbaik?"}) # use the injected client
    assert resp.status_code == 200
    data = resp.json()
    assert data["answer"] == "Jawaban AI"
    assert isinstance(data["products"], list)
    assert len(data["products"]) > 0
    assert "note" in data
    assert data["note"] == "Berikut produk yang sesuai dengan kriteria Anda."

@pytest.mark.asyncio
async def test_get_suggestions(async_client): # Inject the fixture
    resp = await async_client.get("/api/queries/suggestions") # use the injected client
    assert resp.status_code == 200
    data = resp.json()
    assert "suggestions" in data
    assert isinstance(data["suggestions"], list)

@pytest.mark.asyncio
@patch("app.api.queries.product_service")
async def test_get_categories(mock_service, async_client): # Inject the fixture
    mock_service.get_categories = AsyncMock(return_value=["smartphone", "laptop", "tablet"])
    resp = await async_client.get("/api/queries/categories") # use the injected client
    assert resp.status_code == 200
    data = resp.json()
    assert "categories" in data
    assert set(data["categories"]) >= {"smartphone", "laptop", "tablet"}

@pytest.mark.asyncio
@patch("app.api.queries.product_service")
async def test_get_brands(mock_service, async_client): # Inject the fixture
    mock_service.get_brands.return_value = ["Apple", "Samsung", "Sony"]
... (truncated for analysis)
```

**Improvement:**

*   **Use a `pytest` fixture for `AsyncClient`:**  Instead of creating an `AsyncClient` instance within each test function, create a fixture with `scope="module"` to create the client once for the entire module. This avoids redundant creation of the `AsyncClient` for each test, which is relatively expensive.
    *   Also, import the app only once at the top of the module for the same reason.

**Explanation:**

The original code repeatedly creates a new `AsyncClient` within each test function.  Creating and tearing down the client (including the `ASGITransport`) is a relatively slow operation. By using a `pytest` fixture with `scope="module"`, we create a single `AsyncClient` instance and reuse it across all tests in the module.  This reduces overhead and speeds up the overall test execution time, especially when there are many tests making API calls.  `scope="module"` ensures the client persists across all tests in the module but is cleaned up after the module's tests are complete.  Also, now the app is imported once at the top of the module, which will slightly improve the overall efficiency.

---
*Generated by Smart AI Bot*
