# Code Optimization

**File**: `./tests/test_products.py`  
**Time**: 07:40:00  
**Type**: code_optimization

## Improvement

**Optimization:** Move the `AsyncClient` creation and `app` import outside the test functions and use `pytest.fixture` to reuse it.

**Explanation:**

Currently, both `test_get_products` and `test_get_products_with_category` import `app.main.app` and create an `AsyncClient` instance.  Importing the app and creating the client are relatively expensive operations. By using a `pytest.fixture`, we can perform these operations once and reuse the created client for both tests. This reduces redundancy and speeds up the test suite execution time.

```python
import pytest
from httpx import AsyncClient, ASGITransport
from unittest.mock import patch, AsyncMock
from app.main import app  # Import here

@pytest.fixture
async def async_client():
    async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
        yield ac

@pytest.mark.asyncio
@patch("app.api.products.product_service")
async def test_get_products(mock_service, async_client): # Inject the client
    mock_service.get_products = AsyncMock(return_value=[{
        "id": "P001",
        "name": "iPhone 15 Pro Max",
        "category": "smartphone",
        "brand": "Apple",
        "price": 21999000,
        "currency": "IDR",
        "description": "iPhone 15 Pro Max dengan titanium design, kamera 48MP, dan performa terbaik",
        "specifications": {
            "rating": 4.8,
            "sold": 100,
            "stock": 25,
            "condition": "Baru",
            "shop_location": "Indonesia",
            "shop_name": "Apple Store"
        },
        "images": ["https://example.com/P001.jpg"],
        "url": "https://shopee.co.id/P001"
    }])
    resp = await async_client.get("/api/products/")
    assert resp.status_code == 200
    data = resp.json()
    assert isinstance(data, list)
    assert len(data) > 0
    assert all("id" in p and "name" in p for p in data)

@pytest.mark.asyncio
@patch("app.api.products.product_service")
async def test_get_products_with_category(mock_service, async_client):  # Inject the client
    mock_service.get_products = AsyncMock(return_value=[{
        "id": "P001",
        "name": "iPhone 15 Pro Max",
        "category": "smartphone",
        "brand": "Apple",
        "price": 21999000,
        "currency": "IDR",
        "description": "iPhone 15 Pro Max dengan titanium design, kamera 48MP, dan performa terbaik",
        "specifications": {
            "rating": 4.8,
            "sold": 100,
            "stock": 25,
            "condition": "Baru",
            "shop_location": "Indonesia",
            "shop_name": "Apple Store"
        },
... (truncated for analysis)
```

---
*Generated by Smart AI Bot*
