# Error Handling Improvement

**File**: `./app/api/queries.py`  
**Time**: 04:47:11  
**Type**: error_handling_improvement

## Improvement

```python
import logging
from typing import List, Dict
from fastapi import APIRouter, HTTPException, status
from pydantic import BaseModel
from app.services.product_data_service import ProductDataService
from app.services.ai_service import AIService
import re

# Setup logging
logger = logging.getLogger(__name__)

router = APIRouter()
product_service = ProductDataService()
ai_service = AIService()

class QueryRequest(BaseModel):
    question: str

class QueryResponse(BaseModel):
    answer: str
    products: List[dict]
    question: str
    note: str

@router.post("/ask", response_model=QueryResponse)
async def ask_question(request: QueryRequest):
    """Ask a question about products and get recommendations"""
    try:
        # Get AI response
        try:
            ai_response = await ai_service.get_response(request.question)
        except Exception as e:
            logger.error(f"Error during AI service call: {e}")
            raise HTTPException(status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="AI service unavailable") from e
        
        # Get relevant products and fallback message
        # Ekstrak kategori dan max_price dari pertanyaan (sederhana)
        category = None
        max_price = None
        
        # Deteksi kategori dengan lebih lengkap
        question_lower = request.question.lower()
        category_mapping = {
            'laptop': ['laptop', 'notebook', 'komputer'],
            'smartphone': ['smartphone', 'hp', 'handphone', 'phone', 'telepon', 'ponsel'],
            'tablet': ['tablet', 'ipad'],
            'headphone': ['headphone', 'earphone', 'headset', 'audio'],
            'kamera': ['kamera', 'camera', 'fotografi'],
            'audio': ['audio', 'speaker', 'sound'],
            'tv': ['tv', 'televisi'],
            'drone': ['drone', 'quadcopter'],
            'jam': ['jam', 'watch', 'smartwatch']
        }
        
... (truncated for brevity, the rest of the code remains the same)
```

Key improvements in error handling:

* **Specific `try...except` block around the AI service call:**  The code now isolates the `ai_service.get_response` call within its own `try...except` block. This is crucial because it allows us to handle failures specifically related to the AI service, without catching unrelated exceptions in the broader logic.
* **Logging the error:** Inside the `except` block, `logger.error(f"Error during AI service call: {e}")` logs the specific exception that occurred. This is invaluable for debugging and monitoring.  The `f-string` includes the exception message `e` for detailed information.
* **Raising an `HTTPException` with an appropriate status code:** Instead of silently failing or returning potentially incorrect results, the code now raises an `HTTPException` with `status_code=status.HTTP_503_SERVICE_UNAVAILABLE`.  This is the correct HTTP status code to indicate that the service is temporarily unavailable (due to the AI service failure).  The `detail` provides a user-friendly message.
* **Chaining the exception:**  The `from e` clause in `raise HTTPException(...) from e` preserves the original exception's traceback. This is incredibly helpful for debugging, as it allows you to see the full call stack leading to the error in the AI service.
* **Improved Error Message:** The error message now clearly states that the AI service is unavailable, which is more informative than a generic error.

These changes ensure that:

1.  AI service failures are properly detected.
2.  The server doesn't crash or return incorrect results when the AI service is down.
3.  The client receives a clear and informative error message (HTTP 503).
4.  Detailed error information is logged for debugging.
5.  The original exception's traceback is preserved for effective debugging.

---
*Generated by Smart AI Bot*
